## Turn off meaningless jar repackaging 
%define __jar_repack 0

%global base_version 1.0.0

%global pom_version 1.0.0
%global mvn_settings -s mirror-settings.xml

%if %{?build_number:1}%{!?build_number:0}
%define package_version %{base_version}.build%{build_number}
%else
%define package_version %{base_version}
%endif

%define _modulename backend-server
%define prefixname storm

Name:    storm-webdav
Version: %{package_version}
Release: 0%{?dist}
Summary: The StoRM WebDAV server

Group: Applications/File
License:  ASL 2.0
Url: https://github.com/italiangrid/storm-webdav
Source:    %{name}.tar.gz
BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)

BuildArch: noarch

BuildRequires: apache-maven
BuildRequires: jpackage-utils
BuildRequires: java-1.7.0-openjdk-devel

Requires(post):   chkconfig
Requires(preun):  chkconfig
Requires(preun):  initscripts
Requires(postun): initscripts

Requires: java-1.7.0-openjdk
Requires: jpackage-utils


%description
StoRM provides an SRM interface to any POSIX filesystem with direct file
access ("file:" transport protocol), but can take advantage of special
features of high performance parallel and cluster file systems, as GPFS from 
IBM and Lustre from SUN. 

This package contains the StoRM WebDAV server.

%prep
%setup -q -n %{name}

%build
mvn -s mirror-settings.xml -DskipTests -U package

%install
rm -rf $RPM_BUILD_ROOT
mkdir -p $RPM_BUILD_ROOT
tar -C $RPM_BUILD_ROOT -xvzf target/%{name}-server.tar.gz
install -d -m 755 $RPM_BUILD_ROOT%{_datadir}/%{name}/work

%clean
rm -rf $RPM_BUILD_ROOT

%files
%attr(755,root,root) %{_sysconfdir}/init.d/%{name}

%defattr(644,root,root,755)
%dir %{_javadir}/%{name}
%{_javadir}/%{name}/%{name}-server.jar

%config(noreplace) %{_sysconfdir}/sysconfig/%{name}
%config(noreplace) %{_sysconfdir}/%{name}/logback.xml
%config(noreplace) %{_sysconfdir}/%{name}/logback-access.xml
%{_sysconfdir}/%{name}/README.md

%dir %{_sysconfdir}/%{name}/sa.d
%{_sysconfdir}/%{name}/sa.d/README.md
%{_sysconfdir}/%{name}/sa.d/*.template

%dir %{_sysconfdir}/%{name}/vo-mapfiles.d
%{_sysconfdir}/%{name}/vo-mapfiles.d/README.md

%attr(750,storm,storm) %dir %{_localstatedir}/log/%{name}
%attr(755,storm,storm) %dir %{_datadir}/%{name}/work

%pre
# create user storm, if it does not exist
getent group storm > /dev/null || groupadd -r storm
getent passwd storm > /dev/null || useradd -r -g storm \
  -d %{_sysconfdir}/storm -s /sbin/nologin -c "StoRM server account" storm

%post
# when installing
if [ "$1" = "1" ] ; then
  # add the service to chkconfig
  /sbin/chkconfig --add %{name}
# when upgrading
elif [ $1 -gt 1 ] ; then
  # restart the service
  /sbin/service %{name} restart >/dev/null 2>&1 || :
fi

%preun
# when uninstalling
if [ "$1" = "0" ] ; then
  # stop the service
  /sbin/service %{name} stop >/dev/null 2>&1 || :
  # remove the service from chk
  /sbin/chkconfig --del %{name}
fi

%changelog
* Mon Sep 1 2014 Andrea Ceccanti <andrea.ceccanti at cnaf.infn.it> - 1.0.0-0
- Initial packaging
